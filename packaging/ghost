#!/bin/bash
# ghost - CLI launcher for Space Black (installed to /usr/local/bin/ghost)
# Usage: ghost start | ghost update | ghost daemon | ghost help

set -e

INSTALL_DIR="/opt/spaceblack"
VENV_DIR="$INSTALL_DIR/.venv"

# â”€â”€ Auto-setup on first run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setup_if_needed() {
    if [ ! -d "$VENV_DIR" ]; then
        echo "ğŸ”§ First run detected. Setting up Space Black..."
        echo ""

        # Check for Python 3
        if ! command -v python3 &> /dev/null; then
            echo "âŒ Error: python3 not found. Please install Python 3.10+."
            exit 1
        fi

        # Create virtual environment
        echo "ğŸ“¦ Creating virtual environment..."
        python3 -m venv "$VENV_DIR"

        # Install OS-Specific audio deps if script exists
        if [ -f "$INSTALL_DIR/scripts/install_audio_deps.sh" ]; then
            bash "$INSTALL_DIR/scripts/install_audio_deps.sh"
        fi

        # Install dependencies
        echo "â¬‡ï¸  Installing dependencies..."
        "$VENV_DIR/bin/pip" install --upgrade pip > /dev/null 2>&1
        "$VENV_DIR/bin/pip" install -r "$INSTALL_DIR/requirements.txt"

        # Install Playwright browsers
        if "$VENV_DIR/bin/pip" show playwright > /dev/null 2>&1; then
            echo "ğŸŒ Installing Playwright browsers..."
            "$VENV_DIR/bin/playwright" install chromium
        fi

        echo ""
        echo "âœ… Setup complete!"
        echo ""
    fi
}

# â”€â”€ Commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
case "${1:-help}" in
    start)
        setup_if_needed
        echo "ğŸš€ Launching Ghost..."
        cd "$INSTALL_DIR"
        "$VENV_DIR/bin/python" main.py
        ;;
    update)
        echo "ğŸ”„ Updating Space Black..."
        if [ -d "$INSTALL_DIR/.git" ]; then
            cd "$INSTALL_DIR"
            git pull --ff-only
            if [ -d "$VENV_DIR" ]; then
                echo "ğŸ“¦ Updating dependencies..."
                "$VENV_DIR/bin/pip" install -r "$INSTALL_DIR/requirements.txt" --quiet
            fi
            echo "âœ… Update complete! Run 'ghost start' to launch."
        else
            echo "âš ï¸  Package install detected. To update, download the latest package:"
            echo "   curl -fsSL https://spaceblack.info/install.sh | bash"
        fi
        ;;
    daemon)
        setup_if_needed
        echo "ğŸ‘» Starting Ghost Daemon..."
        cd "$INSTALL_DIR"
        "$VENV_DIR/bin/python" main.py daemon
        ;;
    --version|-v|version)
        echo "Space Black v1.0.0"
        ;;
    help|--help|-h|"")
        echo ""
        echo "  Ghost â€” The AI Agent on Space Black"
        echo "  Version: 1.0.0"
        echo ""
        echo "  Usage: ghost <command>"
        echo ""
        echo "  Commands:"
        echo "    start       Launch the Ghost agent TUI (auto-setup on first run)"
        echo "    update      Pull latest code and update dependencies"
        echo "    daemon      Run Ghost as a background service"
        echo "    help        Show this help message"
        echo ""
        echo "  Options:"
        echo "    --help      Show this help message"
        echo "    --version   Show version number"
        echo ""
        echo "  Examples:"
        echo "    ghost start           Launch the interactive TUI"
        echo "    ghost update          Update to the latest version"
        echo "    ghost daemon          Start the background daemon"
        echo ""
        echo "  Docs:   https://spaceblack.info/docs"
        echo "  GitHub: https://github.com/udaysagarm/SpaceBlack"
        echo ""
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'ghost --help' for usage."
        exit 1
        ;;
esac
